# SublimeVideo Async Data2 Server (Goliath)

## Installation

copy `.gitconfig` content to `.git/config`

``` bash
bundle install
```

## Development

Running Goliath:

``` bash
bundle exec ruby application.rb -sv
```

## Deployment

``` bash
git push production2
```

Don't forget to set MONGOHQ_URI env variable and set a custom index on the `video_tag_crc32_hashes` collection with:

`
db.video_tag_crc32_hashes.ensureIndex( { "t": 1 }, { expireAfterSeconds: 86400 } )
`

so crc32 hash are automaticaly removed after 1 day.


## CORS data requests

CORS Ajax requests are always sent to the same url via POST HTTP(S):

`POST //data2.sublimevideo.net/data/<site token>.json`

The params (json) sent can include multiples requests event types (load, play, video tag data, video tag crc32 hash request) in any order all sent via an array, ie:

```
[
  { l: { # load event params } },
  { s: { # start play event params } },
  { s: { # start play event params },
  { h: { # video tag crc32 hash request params } },
  { v: { # video tag data params } },
]
```

All requests will be managed and parsed separately by the server. Event type params (e) is mandatory for each request. To begin, only 'video tag data' and 'video tag crc32 hash request' will be supported.

Some request types need a response (like 'video tag crc32 hash request') so in some case an array of responses (json) can be sent back. Order of responses aren't related to order of requests.

### CORS – Video tag crc32 hash request

This request type is sent every times a video tag is loaded in the page to know if the video tag data is in sync with mysv. If the video crc32 hash returned is different than the one in place in the browser the new data are sent via a new 'video tag data' request.

Request params:

```
{
  h: { # video tag crc32 hash request event
    u: <video uid>
  }
}
```

Response params:

```
{
  h: {
    u: <video uid>,
    h: <video tag crc32 hash on mysv side>
  }
}
```

Note:

- Video tag crc32 hash can be null, if inexsitent or old on mysv side.
- Player must not do that request for video tag in an auto-embed iframe.
- Player must not do that request if uid is invalid ([regex](https://basecamp.com/1793177/projects/1896719-stats-new-videotag/documents/2126214-data-uid-validation)).
- Player must do that request only for main & extra (alias) hostnames.

Video tag data crc32 hash generation:

The video tag data used to generate the crc32 hash are all video tag data without source's urls and player size (that change on a responsive site). When autoembed is true, videos sources are used to generate the crc32.

### CORS – Video tag data

This request is sent when the video tag crc32 hash returned by mysv differ from the one generated by the player. This event type (v) sends all video tag data needed to re-generate the video tag (data-settings, sources, poster,... everything!)

Request params:

```
{
  v: { # video data event type
    h: <new video tag crc32 hash>,
    # ... SEE LIST BELOW
  }
}
```

```
h, new Video tag crc32 hash, e.g. h: "23ads4ad"
u, Video uid, e.g. u: "asd123ef"
i*, Video id (sublimevideo hosting or youtube), e.g. i: "12asd2ea"
io*, Video id origin  (sublimevideo/youtube), e.g. io: "sv" / io: "y"
t*, Video title, e.g. n: "My Awesome Video"
p*, Video poster url, e.g. p: "http://posters.sublimevideo.net/123asda3.png"
z, Player size, e.g. z: "400x300"
s*, Video sources hash, see below params for each source
a*, Video data attributes (settings) hash.
o*, Video options hash (ie. { autoembed: true })
```

(*) optional param, nil/false if not present

Video sources of hash params:

```
s: [{
  u: "<video source url>",
  q: "<video source quality (hd/base)>",
  f:  "<video source family (mp4/webm/ogg)>"
  },
  # other sources...
]
}
```
No respond need to be sent back.
